(ns advent-2020.day-14
  (:require [clojure.string :as string]))


(defn decode
  [input]
  (map (fn [instruction]
         (if (string/starts-with? instruction "mask")
           [:mask (subs instruction 7)]
           (into [:mem] (map #(Long/parseLong %)) (re-seq #"[0-9]+" instruction))))
       (string/split-lines input)))


(defn mask-val
  [mask val]
  (let [bin-val (Long/toString val 2)
        padded-bin-val (into (vec (repeat (- (count mask) (count bin-val)) \0)) bin-val)]
    (Long/parseLong (apply str (map (fn [b m] (if (= \X m) b m)) padded-bin-val mask)) 2)))


(defn run-program
  [input mem-update-rule]
  (->> (decode input)
       (reduce
         (fn [{:keys [mem mask] :as store} [instruction & args]]
           (if (= :mask instruction)
             (assoc store :mask (first args))
             (assoc store :mem (let [[address val] args] (mem-update-rule mem mask address val)))))
         {:mem {} :mask nil})
       (:mem)
       (vals)
       (reduce +)))


(defn part-1
  [input]
  (run-program input (fn [mem mask address val] (assoc mem address (mask-val mask val)))))


(defn apply-mask
  [[m & remaining-mask] [a & remaining-address]]
  (cond
    (nil? m) [[]]
    (= \1 m) (map (partial cons \1) (apply-mask remaining-mask remaining-address))
    (= \0 m) (map (partial cons a) (apply-mask remaining-mask remaining-address))
    (= \X m) (concat (map (partial cons \1) (apply-mask remaining-mask remaining-address))
                     (map (partial cons \0) (apply-mask remaining-mask remaining-address)))))


(defn mask-address
  [mask address]
  (let [bin-address (Long/toString address 2)
        padded-address-val (concat (repeat (- (count mask) (count bin-address)) \0) bin-address)]
    (apply-mask mask padded-address-val)))


(defn part-2
  [input]
  (run-program
    input
    (fn [mem mask address val]
      (reduce (fn [mem address] (assoc mem address val)) mem (mask-address mask address)))))


(def small-input
  "mask = XXXXXXXXXXXXXXXXXXXXXXXXXXXXX1XXXX0X\nmem[8] = 11\nmem[7] = 101\nmem[8] = 0")


(def small-input-2
  "mask = 000000000000000000000000000000X1001X\nmem[42] = 100\nmask = 00000000000000000000000000000000X0XX\nmem[26] = 1")


(def large-input
  "mask = 001X11X1X010X1X1010XX10X100101011000\nmem[43398] = 563312\nmem[51673] = 263978\nmem[18028] = 544304215\nmask = X0100001101XX11100010XX110XX11111000\nmem[24151] = 2013\nmem[15368] = 19793\nmem[45005] = 478\nmem[1842] = 190808161\nmem[36033] = 987\nmem[26874] = 102\nmask = 00X0000110110X000110010101XX0X010001\nmem[9507] = 7\nmem[50019] = 16475608\nmem[4334] = 129799\nmem[37373] = 182640\nmem[28170] = 534617265\nmem[6432] = 354252\nmem[36752] = 834628\nmask = 10100000101101100110X001X0X001100X10\nmem[36664] = 30481\nmem[6532] = 103013119\nmem[45659] = 15629\nmem[19533] = 167227\nmem[40461] = 344193233\nmem[6217] = 26713310\nmask = X0XX010100110101X0001101X11100X100X0\nmem[38530] = 6202\nmem[53032] = 13775\nmem[39333] = 1003152\nmem[3932] = 1240562\nmem[59246] = 12638\nmask = 0X1X010100X001X0011000X10000011X11X1\nmem[51007] = 43736089\nmem[32553] = 977\nmem[5131] = 323347526\nmem[21451] = 176282356\nmem[22857] = 118\nmem[50924] = 217\nmask = 001111X110100X11X100000011110111X100\nmem[3954] = 3854\nmem[19628] = 6778501\nmem[29233] = 104\nmem[18456] = 135287\nmem[10018] = 379\nmem[14384] = 969770374\nmask = 0X1X000110X1X10001100110100X01000001\nmem[25112] = 62086\nmem[22964] = 2379583\nmem[45021] = 1429003\nmask = X010XX11X0110110011XX000011000110001\nmem[17265] = 180092\nmem[36033] = 495818745\nmem[28455] = 7765821\nmask = 01000X0110110001100X01X1111000XXX001\nmem[395] = 37390\nmem[6432] = 962\nmem[10247] = 130364\nmem[10136] = 529\nmem[62469] = 62129\nmask = 00001100X010X110011X0000111X0X100XX1\nmem[8811] = 206575\nmem[37066] = 41\nmem[53499] = 1505104\nmem[22863] = 59636084\nmem[50013] = 45392\nmem[29757] = 1343911\nmask = 001000011010X10X10000001XX011X000010\nmem[23068] = 8829046\nmem[49194] = 614470096\nmask = XX1X000110X101100X101100X01101X00X11\nmem[62870] = 3995829\nmem[61328] = 18642\nmem[50232] = 70531300\nmem[48827] = 17923\nmem[12416] = 530017\nmem[33496] = 181946\nmask = 00100X0110XX00011X00000X101100X10100\nmem[64825] = 5590\nmem[55315] = 3210\nmem[532] = 92226\nmask = 00X0XX0000100110011010X0X00XX101011X\nmem[35112] = 1037772\nmem[46051] = 5636\nmem[32440] = 5415168\nmem[6812] = 64661\nmask = XX1111110010110X010XXX0010X0110XX001\nmem[2313] = 14107547\nmem[57582] = 3420940\nmask = 0X100X01101X011101001001111101110X1X\nmem[1584] = 1309601\nmem[45021] = 142440\nmem[52855] = 22177947\nmask = 001X1X11XX101101010010X01X00X100X000\nmem[51649] = 224687001\nmem[30137] = 16118\nmem[49157] = 1286\nmask = 0011010X001X0101110X01000X11011X0100\nmem[8527] = 483\nmem[23222] = 60397\nmem[47303] = 4597311\nmask = 1010001110X00X0010000X100X0X01011100\nmem[61912] = 65321\nmem[28793] = 217\nmem[3216] = 2226\nmem[15267] = 196\nmem[12210] = 634690438\nmask = XX100001100101011XX000001X0X00X10X10\nmem[52112] = 232196\nmem[5131] = 8215922\nmem[21390] = 97675\nmem[60773] = 295919\nmem[10967] = 188393052\nmem[30137] = 40094772\nmask = 01100X00001X0111X11001011X000X1010X0\nmem[47036] = 8270917\nmem[26111] = 3884\nmem[48992] = 3941\nmem[21396] = 9612429\nmask = X01X01X0100X101001XX00001X1101X00110\nmem[47036] = 785762\nmem[20586] = 91901152\nmem[38530] = 338166139\nmem[29577] = 753085\nmask = X01001010001011100X01XX010010011X000\nmem[50548] = 31352881\nmem[17969] = 264\nmem[12532] = 122897915\nmask = 100X0X011011110001001XX0100110010101\nmem[7092] = 488918089\nmem[5131] = 2146748\nmem[13662] = 1422934\nmem[54353] = 299758672\nmem[17622] = 15998\nmem[12416] = 48024869\nmem[15520] = 925305185\nmask = X010000100X1000X1000X10010X010100010\nmem[49608] = 17989\nmem[5478] = 192384\nmem[7958] = 729\nmask = 0010X001X1100X1X1X000100XX10100X1100\nmem[47164] = 170643\nmem[1049] = 151435402\nmem[24631] = 47998921\nmask = 101001XX0X1X010110011101000110110111\nmem[39780] = 29719\nmem[20606] = 714268\nmem[40889] = 367330023\nmem[6414] = 28304231\nmem[63401] = 1417\nmask = 1X10010X00X10101100X010110X1100X1001\nmem[38445] = 392\nmem[14087] = 19086\nmem[36110] = 7609\nmem[61683] = 24000\nmem[55077] = 2975\nmem[2109] = 446867\nmask = 011000011X010X0X1X100110100001X1XX10\nmem[32849] = 150162\nmem[22563] = 3985\nmem[10602] = 225990962\nmask = 00X00X01X00001X1X0000X00101100100110\nmem[43197] = 134523909\nmem[65396] = 266246531\nmem[54292] = 263069\nmem[7677] = 99022189\nmem[16568] = 15208393\nmask = 1X100X011X1000111000XX1100011X00X0X1\nmem[2877] = 1577\nmem[39731] = 1276\nmem[10602] = 844609393\nmem[13447] = 4710\nmask = 0010X00110XX0101100X00XX100110X10100\nmem[10466] = 93198549\nmem[21290] = 624\nmem[2948] = 51676784\nmem[23734] = 6032\nmem[29894] = 48902591\nmem[271] = 60066\nmask = 1011000110X1011X001X11110100110111X0\nmem[1843] = 1562\nmem[1049] = 9936\nmem[14474] = 305948608\nmem[40634] = 680784423\nmem[9394] = 12344199\nmask = 000011X000100X10011X000X001100X10X10\nmem[37198] = 9587\nmem[40486] = 15533376\nmem[28252] = 1625\nmem[59079] = 166206\nmask = 0010010110110XXXXX0X0001100100000X00\nmem[40119] = 168760390\nmem[63012] = 1016\nmem[6964] = 13134\nmem[6116] = 19700991\nmem[60039] = 492285\nmask = 10X000011X10001X100000111X10000101X0\nmem[532] = 16484832\nmem[48228] = 18188385\nmem[65048] = 14886349\nmem[29631] = 1088356\nmask = 0100X00110110X00XXX010110X11X111100X\nmem[24637] = 561045\nmem[62166] = 62287574\nmem[395] = 1350\nmem[46447] = 15165\nmask = 01101XX100110X1X11001X0X0X0X01011110\nmem[29481] = 88712206\nmem[8052] = 965421\nmask = X0X0010100X1X101101X111010X11010X10X\nmem[27388] = 41257883\nmem[22151] = 2499234\nmem[17067] = 1210879\nmask = 00100001X0X10X0110000000101XX001010X\nmem[148] = 43621\nmem[23734] = 243862817\nmask = 101000XX1010001110000X1X00011X0X0100\nmem[19226] = 7783454\nmem[47036] = 32167689\nmem[54708] = 28465363\nmem[25775] = 13654\nmem[38159] = 226030009\nmem[33886] = 22797977\nmem[47934] = 34738195\nmask = 1010000110110111000101011X0XX1X111X1\nmem[8015] = 1639518\nmem[32888] = 89628061\nmem[19414] = 3293870\nmem[45803] = 3055\nmem[2849] = 517315\nmem[7103] = 1807237\nmask = 0010010X1X110111011010001X010X10X110\nmem[32337] = 14059\nmem[7162] = 22418419\nmem[62068] = 491160015\nmem[52514] = 62411508\nmem[21998] = 16113734\nmem[14899] = 4165873\nmask = 01000101101001100110XX01011XX0X00XX0\nmem[63651] = 706\nmem[27388] = 269141496\nmem[16791] = 90544\nmem[58514] = 2084386\nmem[6512] = 82029923\nmask = XX100X0X1011011X0110X00000011X10XX10\nmem[25492] = 51834825\nmem[39104] = 11018\nmem[31518] = 5721690\nmask = X01001X0101101110X10010111X11X110000\nmem[16817] = 43478591\nmem[49714] = 32182\nmem[7715] = 20391\nmem[36282] = 511726\nmem[2709] = 58604\nmask = 10100001101000XX10001001X110001101X0\nmem[21290] = 96121933\nmem[4581] = 935753770\nmem[10322] = 214308733\nmem[22563] = 955\nmem[21998] = 174320\nmask = 001X010010XXXX10011010010XX01X0X0100\nmem[27908] = 10394\nmem[58731] = 17043901\nmem[12207] = 89277\nmem[50189] = 70951683\nmem[40310] = 1070062397\nmask = X11001X11010X1100110X101X0100X0X01X0\nmem[48661] = 35809\nmem[6512] = 466\nmem[22172] = 9259291\nmask = 001X0001X001010XX001000010X1001X1111\nmem[45021] = 7965\nmem[10414] = 132450\nmask = X11001111X10111001X001010X001X00011X\nmem[22734] = 23954922\nmem[18333] = 522531412\nmem[21084] = 2928539\nmask = 0010000X00110101XX0XX111100100100110\nmem[10793] = 30167743\nmem[54236] = 15119211\nmem[46526] = 34600696\nmask = X010010100X10101X0011X0010000X1XXXX1\nmem[40874] = 107825637\nmem[12207] = 5066\nmem[64061] = 12594443\nmem[14677] = 104815480\nmem[47294] = 27328513\nmem[36871] = 99385\nmem[55732] = 3825863\nmask = 0010X10X101X011101X000011X1100110000\nmem[39282] = 9472566\nmem[19564] = 55941\nmem[8527] = 26084\nmem[10265] = 130187\nmem[6432] = 865842\nmem[20931] = 1702\nmask = 00110X0010X01X1001101X0000XX1XX0110X\nmem[54465] = 11299\nmem[13022] = 487449\nmask = 00100XXX101101101101111010X100100000\nmem[20710] = 1510193\nmem[1742] = 2963920\nmem[15368] = 241191\nmem[48928] = 8865\nmask = 0X10XX0100X10X011000X01101X0X1101110\nmem[33496] = 157963055\nmem[10527] = 1744363\nmem[25912] = 24812738\nmem[53894] = 65229499\nmem[27656] = 195539\nmem[56053] = 84622\nmem[58013] = 503836980\nmask = 00X0000X10X1011X0X10110011111X000011\nmem[21324] = 100568910\nmem[11832] = 25433857\nmem[15696] = 65297\nmask = 00100X010011010110XX01X11XX1001X0111\nmem[1742] = 5701\nmem[50038] = 1734\nmem[3338] = 10181349\nmem[64950] = 715735117\nmem[3094] = 6261\nmask = 01XX01001010X1X101XX000010X111110XX0\nmem[30706] = 34032209\nmem[57669] = 953918\nmem[2368] = 18511\nmem[58246] = 14197924\nmem[12602] = 3821248\nmem[37932] = 73626\nmask = 00X0000110X000011XX0000011100X000000\nmem[44726] = 577645454\nmem[31822] = 2444199\nmask = X0100X01X110001X1X0000X01010X0X00111\nmem[40204] = 167462\nmem[13234] = 334\nmem[55553] = 649450\nmem[18698] = 152213289\nmem[56964] = 1004699\nmem[17434] = 557\nmask = 0X1000011111XX01X01XX10X0100000000X1\nmem[54363] = 171716\nmem[27133] = 813977\nmem[25112] = 478238\nmem[2734] = 2300\nmem[23972] = 7597\nmask = 0110X1X1X011011XX10010X11100X1111X00\nmem[21998] = 2245\nmem[39814] = 10501801\nmem[16186] = 807\nmask = X010000110100001100X0011X11000XX0010\nmem[21976] = 1290104\nmem[45127] = 1447\nmem[19564] = 679\nmem[8927] = 40098844\nmem[43124] = 2060353\nmem[17227] = 11511\nmask = X110X00110X10101111000X0000X10111110\nmem[25530] = 23237\nmem[55910] = 1785756\nmem[38723] = 1821559\nmem[30849] = 4089\nmem[532] = 661\nmask = 0X10010XX01X011X011000011X01X1X001X0\nmem[17212] = 6523\nmem[37424] = 480\nmem[40862] = 449969985\nmem[28474] = 40994780\nmem[21577] = 36128\nmem[39066] = 7501680\nmask = X100X101100X01X001101001X11001111110\nmem[35142] = 186426\nmem[28005] = 1296725\nmem[57552] = 433183\nmem[26566] = 56636\nmem[4581] = 1646680\nmem[35799] = 2658\nmask = 001011010001X00110X00X10000001011X10\nmem[13674] = 62138919\nmem[63552] = 11168\nmem[11669] = 56357099\nmask = 101000XX1010XX0010000X10XX1100010010\nmem[22434] = 34054009\nmem[19261] = 856\nmem[24828] = 7024\nmem[34924] = 648168\nmem[22917] = 9557844\nmask = 10100X0X1011111100X1010000000111100X\nmem[63552] = 11477437\nmem[23072] = 8131648\nmem[19002] = 1064\nmem[23946] = 183\nmem[2440] = 1277\nmask = X0100001101X000X100001001X1X00110110\nmem[55553] = 49381\nmem[25631] = 41125881\nmem[62633] = 590643\nmask = 0X1000011001010001XX11X0010100000000\nmem[10466] = 506832\nmem[23072] = 5583\nmem[45005] = 8337603\nmem[59216] = 7005456\nmask = 0XXX000111111001X0100100001000000100\nmem[19928] = 48311172\nmem[22974] = 815\nmem[34266] = 13786112\nmem[1742] = 9648313\nmem[1094] = 162\nmem[55709] = 31320282\nmask = 0XX0000110100XX1X001001001X001000001\nmem[22346] = 340600\nmem[39104] = 935807\nmem[64441] = 570\nmem[56853] = 3313\nmem[22434] = 1892025\nmask = 01X000X1X0110XXXX1100110000X00101000\nmem[26813] = 23072664\nmem[9142] = 282783543\nmem[29807] = 14754\nmem[56288] = 62827\nmask = 01X0010X1XX001X001X010X011100100X100\nmem[47774] = 352023\nmem[5938] = 132498542\nmem[24828] = 8444211\nmem[55829] = 238313735\nmask = 0010010100X101X10XX0X10X110100XX1X00\nmem[1908] = 30255\nmem[40461] = 1524854\nmem[21752] = 3313\nmem[38177] = 164\nmem[32888] = 20182288\nmem[17656] = 2560835\nmask = 01000101101XX11X0110X10X0000X1XX0000\nmem[18028] = 6424701\nmem[11832] = 73576\nmem[18812] = 15408\nmask = X010X00XXXX1X1100100X1101X1111110010\nmem[31868] = 1008118155\nmem[16970] = 560\nmem[6414] = 659729\nmask = 00100X0110X1010001X0XXX1X00100100X00\nmem[60039] = 1335434\nmem[22051] = 4352989\nmem[23413] = 8881\nmem[5131] = 3574\nmem[31132] = 1822377\nmem[59227] = 3565275\nmem[55044] = 629\nmask = 101001010001X101100X1XX01X01100X1111\nmem[2119] = 6096\nmem[25137] = 4534409\nmem[34466] = 2697336\nmem[24201] = 506176\nmem[25286] = 110343\nmask = 0XX00001101100011000010X101X0X11X100\nmem[29807] = 25323\nmem[12207] = 27513971\nmem[9003] = 1398544\nmem[28341] = 50817018\nmem[30137] = 115\nmem[42114] = 67247621\nmask = 0000X1000010X1X0011010111X0X01X11X10\nmem[48228] = 2010329\nmem[45718] = 71839\nmem[33886] = 136902\nmem[51771] = 2015\nmask = X000000110X101000100000010010X0011X0\nmem[4243] = 33894587\nmem[64857] = 8145\nmem[45718] = 97465094\nmem[53834] = 3359009\nmask = 0010X101000101011X0X01X0101000000001\nmem[24012] = 379049\nmem[39780] = 26758\nmem[59983] = 495835\nmem[37409] = 1160\nmem[52514] = 6321\nmem[27459] = 147\nmem[41942] = 217105\nmask = 00100001100101011X101X0X10111XX10000\nmem[17846] = 10118006\nmem[59737] = 2963\nmem[34644] = 35114650\nmem[13172] = 143244\nmem[5938] = 51096\nmem[44123] = 3352\nmask = 001000X1101101X001X001XX00110101X0X0\nmem[38177] = 2168495\nmem[11075] = 7671\nmem[47735] = 2437651\nmem[57709] = 103925776\nmem[9577] = 253960744\nmem[61912] = 713476954\nmem[10466] = 509335816\nmask = 0X10X00110010100011000001X01001X0001\nmem[46526] = 985771\nmem[63247] = 474051554\nmem[22968] = 581\nmem[29811] = 4967030\nmem[57544] = 438283695\nmem[7042] = 308851\nmask = 001XXX010011X10XX100010X1100X0010100\nmem[22856] = 10167\nmem[25967] = 196716\nmem[17344] = 30111\nmem[3954] = 21193\nmask = 011000XX1101000X00X00101001111000000\nmem[45718] = 22050\nmem[4315] = 28856671\nmem[3954] = 1669054\nmask = XXX000011X11X1000XX011X100X100010101\nmem[25208] = 62883413\nmem[40039] = 460470\nmem[27976] = 317910\nmem[6549] = 3697104\nmem[34078] = 112\nmem[62178] = 479428706\nmask = 0110000111X1X0X1X0100100XXX001XX0010\nmem[532] = 4184102\nmem[25575] = 20376\nmem[59465] = 35723765\nmem[32827] = 2041066\nmem[21963] = 519238\nmem[56441] = 22508\nmask = X0100001101101000100000X0011X01000X0\nmem[34078] = 36026\nmem[12451] = 602257\nmask = 10X0010100X1X10110010010100X0X100011\nmem[52291] = 3349730\nmem[51550] = 12311148\nmem[27235] = 986707194\nmem[7958] = 2162\nmem[36824] = 3705422\nmask = 011X0X0111010000X110000X1X01XX0XX100\nmem[21004] = 1994888\nmem[10900] = 11111\nmem[24854] = 1327\nmem[45320] = 1739644\nmem[29894] = 1918\nmem[62034] = 165719\nmask = 1XX10X10100X1010X1000100X0X10X001X00\nmem[54431] = 68179\nmem[48498] = 269569\nmem[25492] = 53144423\nmem[24130] = 510\nmem[9579] = 22225\nmask = 0X00X101101011X00110X0001001010011X0\nmem[54156] = 597982\nmem[3020] = 27476\nmem[18748] = 105524\nmem[37066] = 28361301\nmem[43484] = 19990814\nmem[18698] = 635178\nmask = X0100001101000X1100X0110XX11111X1000\nmem[44272] = 88008\nmem[11075] = 919\nmem[41491] = 2905\nmem[4898] = 32296\nmem[10607] = 10054\nmem[28252] = 31037")
